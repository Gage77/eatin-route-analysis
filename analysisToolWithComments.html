<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Directions service</title>
    <link rel="stylesheet" href="teststyle.css">
  </head>

  <body>
    <p>Select local CSV File:</p>
    <input id="csv" type="file">

    <output id="out">
      file contents will appear here
    </output>

    <p id="table"> table goes here </p>
    <button id="go">Go!</button>

    <div id="map"></div>
    <!--main script to calculate routes after selecting a local CSV containing addresses-->
    <script>
      //global variables
      //big routes array
      var routesMoW = [];

      //initialize map function
      function initMap() {
        //creating google map variables (API ones)
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 7,
            //centering on Norman
            center: {lat: 35.22, lng: -97.44}
        });
        //tells where to display directions
        directionsDisplay.setMap(map);

        //action handler used to call calculate and display route
        //this is the one with the bad for loop that throws an error sometimes
        //OVER_QUERY_LIMIT = too many google requests per second. Ideas on how to get around that would be awesome
        var onChangeHandler = function() {
          for (var i = 2; i<routesMoW.length; ++i) {
              //calls calculate and display route with the route saved in i
              calculateAndDisplayRoute(directionsService, directionsDisplay, i);
          }
        };

        document.getElementById('go').addEventListener('click', onChangeHandler);
      }

      //mostly used from existing
      function calculateAndDisplayRoute(directionsService, directionsDisplay, i) {

        var routes  = routesMoW[i]
      	directionsService.route({
          origin: "Norman Regional Hospital, Norman, OK",
          waypoints: routesMoW[i],  //addresses from list
          optimizeWaypoints: true,
          destination: routes[routes.length-1].location,  //get better one
          travelMode: 'DRIVING'
          }, function(response, status) {
            if (status === 'OK') {
              //shows directions - questionably necessary
              directionsDisplay.setDirections(response);
              //calculates time - necessary
              showDistance(response);
            }
            else {
              window.alert('Directions request failed due to ' + status);
            }
        });
      }

      function showDistance(directionResult) {
        var distance = 0
        var time = 0
        for (var i = 2; i<directionResult.routes[0].legs.length; i++) {
            distance += directionResult.routes[0].legs[i].distance.value;
            time += directionResult.routes[0].legs[i].duration.value;
        }

        //outputs all of the info. NEEDS BETTER FORMATTING
        console.log(distance)
        console.log(time)
        console.log(distance/1609.34 + " miles")
        console.log(time/60 + " minutes")
      }

      //file input reader found when I googled "How to read in a csv file to javascript"
      var fileInput = document.getElementById("csv"),

      readFile = function () {
        var reader = new FileReader();

        reader.onload = function () {
            successFunction(reader.result);
        };

        function successFunction(data) {
          var allRows = data.split(/\n/);
          var table = '<table id = "myTable">';

          //variables to keep track of previously assigned routes
          var prevRoute = 'NULL';
          var currRoute = 'NULL';
          //empty array for addresses
          var waypts = [];

          //builds table - questionably necessary
          for (var singleRow = 0; singleRow < allRows.length; singleRow++) {
            if (singleRow === 0) {
              table += '<thead>';
              table += '<tr>';
            }
            else {
              table += '<tr>';
            }

            var rowCells = allRows[singleRow].split('"');
            for (var rowCell = 0; rowCell < rowCells.length; rowCell++) {
              if (singleRow === 0) {
                table += '<th>';
                table += rowCells[rowCell].replace(/,/,"");
                table += '</th>';
              }
              else {
                table += '<td>';
                table +=  rowCells[rowCell].replace(/,/,"");
                table += '</td>';
              }
            }

            table += '<td>';
            //pulls address - a LOT more necessary
            var address = rowCells[3].replace(/,/,"") + ' ' + rowCells[5].replace(/,/,"") + ', ' +rowCells[7].replace(/,/,"") + ' ' + rowCells[9].replace(/,/,"");
            table += address
            table += '</td>'

            //keeps track of route
            prevRoute = currRoute;
            currRoute = rowCells[11].replace(/,/,"");
            //if still current route, add it
            if (currRoute === prevRoute) {
              waypts.push({
                location: address,
                stopover: true
              });
            }
            else {
              //else, add that array to the big one and start over for next route
              routesMoW.push(waypts);
              waypts = [];
              waypts.push({
                location: address,
                stopover: true
              });
            }

            if (singleRow === 0) {
              table += '</tr>';
              table += '</thead>';
              table += '<tbody>';
            }
            else {
              table += '</tr>';
            }
          }
          routesMoW.push(waypts);

          table += '</tbody>';
          table += '</table>';

          document.getElementById('table').innerHTML = table;
        }

        // start reading the file. When it is done, calls the onload event defined above.
        reader.readAsBinaryString(fileInput.files[0]);
      };

      fileInput.addEventListener('change', readFile);
    </script>

    <!--map script that creates an instance of google maps-->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-sHAH9e4fv3kNl08mUwh1vYUKRfO0di8&callback=initMap"></script>
  </body>
</html>
